# 脚本执行文档

本文档详细说明了项目中所有脚本的用途、参数和执行方法。

## 目录

1. [数据处理脚本](#数据处理脚本)
2. [训练脚本](#训练脚本)
3. [评估脚本](#评估脚本)
4. [部署脚本](#部署脚本)

---

## 数据处理脚本

### 1. download_dataset.py

**功能**：自动下载FLIR和KAIST红外数据集

**位置**：`scripts/data/download_dataset.py`

**执行方式**：
```bash
python scripts/data/download_dataset.py [选项]
```

**参数说明**：
| 参数 | 说明 | 默认值 |
|-----|------|--------|
| --flir | 仅下载FLIR数据集 | - |
| --kaist | 仅下载KAIST数据集 | - |
| --output-dir | 数据保存目录 | data/raw/ |
| --skip-existing | 跳过已存在的文件 | False |

**使用示例**：
```bash
# 下载所有数据集
python scripts/data/download_dataset.py

# 仅下载FLIR数据集
python scripts/data/download_dataset.py --flir

# 指定输出目录
python scripts/data/download_dataset.py --output-dir /data/datasets/
```

---

### 2. prepare_flir.py

**功能**：将FLIR数据集转换为YOLO训练格式

**位置**：`scripts/data/prepare_flir.py`

**执行方式**：
```bash
python scripts/data/prepare_flir.py [选项]
```

**参数说明**：
| 参数 | 说明 | 默认值 | 必需 |
|-----|------|--------|------|
| --input | FLIR数据集原始路径 | - | 是 |
| --output | 输出目录 | data/processed/flir/ | 否 |
| --split-ratio | 训练集比例 | 0.8 | 否 |
| --img-size | 目标图像尺寸 | 640 | 否 |
| --classes | 检测类别 | person,car,bicycle | 否 |
| --visualize | 可视化部分结果 | False | 否 |

**使用示例**：
```bash
# 基本使用
python scripts/data/prepare_flir.py --input data/raw/flir

# 完整参数
python scripts/data/prepare_flir.py \
    --input data/raw/flir \
    --output data/processed/flir \
    --split-ratio 0.8 \
    --img-size 640 \
    --classes person,car,bicycle \
    --visualize
```

**输出结构**：
```
data/processed/flir/
├── images/
│   ├── train/          # 训练图像
│   └── val/            # 验证图像
├── labels/
│   ├── train/          # 训练标签(YOLO格式)
│   └── val/            # 验证标签
└── dataset.yaml        # 数据集配置文件
```

---

### 3. prepare_kaist.py

**功能**：准备KAIST数据集用于跟踪算法评估

**位置**：`scripts/data/prepare_kaist.py`

**执行方式**：
```bash
python scripts/data/prepare_kaist.py [选项]
```

**参数说明**：
| 参数 | 说明 | 默认值 | 必需 |
|-----|------|--------|------|
| --input | KAIST数据集路径 | - | 是 |
| --output | 输出目录 | data/processed/kaist/ | 否 |
| --modality | 图像模态(thermal/visible/both) | thermal | 否 |
| --extract-frames | 是否提取视频帧 | True | 否 |

**使用示例**：
```bash
python scripts/data/prepare_kaist.py \
    --input data/raw/kaist \
    --output data/processed/kaist \
    --modality thermal
```

---

## 训练脚本

### 1. train_yolov5.py

**功能**：训练YOLOv5目标检测模型

**位置**：`scripts/train/train_yolov5.py`

**执行方式**：
```bash
python scripts/train/train_yolov5.py [选项]
```

**参数说明**：
| 参数 | 说明 | 默认值 | 必需 |
|-----|------|--------|------|
| --config | 训练配置文件 | configs/train_config.yaml | 否 |
| --data | 数据集配置文件 | configs/dataset.yaml | 否 |
| --weights | 预训练权重 | yolov5s.pt | 否 |
| --epochs | 训练轮数 | 300 | 否 |
| --batch-size | 批量大小 | 32 | 否 |
| --img-size | 输入图像尺寸 | 640 | 否 |
| --device | 训练设备 | 0 | 否 |
| --name | 实验名称 | exp | 否 |
| --backbone | 骨干网络类型 | c3/ghost/shuffle | 否 |
| --loss | 损失函数类型 | ciou/siou/eiou | 否 |
| --attention | 注意力机制 | none/cbam/coordatt/se | 否 |
| --resume | 断点续训路径 | - | 否 |
| --workers | 数据加载线程数 | 8 | 否 |
| --seed | 随机种子 | 42 | 否 |

**使用示例**：
```bash
# 基准模型训练
python scripts/train/train_yolov5.py \
    --weights yolov5s.pt \
    --epochs 300 \
    --batch-size 32 \
    --name baseline

# 使用Ghost-C3骨干网络
python scripts/train/train_yolov5.py \
    --weights yolov5s.pt \
    --backbone ghost \
    --name exp_ghost

# 使用CBAM注意力机制 + SIoU损失
python scripts/train/train_yolov5.py \
    --weights yolov5s.pt \
    --attention cbam \
    --loss siou \
    --name exp_cbam_siou

# 多GPU训练
python -m torch.distributed.launch --nproc_per_node 2 \
    scripts/train/train_yolov5.py \
    --batch-size 64 \
    --device 0,1
```

**输出文件**：
```
outputs/
├── weights/
│   ├── {name}/
│   │   ├── best.pt         # 最优模型
│   │   ├── last.pt         # 最后一轮模型
│   │   └── epoch_*.pt      # 检查点
└── logs/
    └── {name}/
        ├── events.out.*    # TensorBoard日志
        └── results.csv     # 训练指标记录
```

---

### 2. ablation_study.py

**功能**：自动运行消融实验

**位置**：`scripts/train/ablation_study.py`

**执行方式**：
```bash
python scripts/train/ablation_study.py [选项]
```

**参数说明**：
| 参数 | 说明 | 默认值 | 必需 |
|-----|------|--------|------|
| --config | 基础配置文件 | configs/train_config.yaml | 否 |
| --output | 结果输出目录 | outputs/results/ablation/ | 否 |
| --experiments | 实验配置 | all | 否 |
| --epochs | 每个实验的训练轮数 | 100 | 否 |
| --skip-existing | 跳过已完成的实验 | False | 否 |

**使用示例**：
```bash
# 运行全部消融实验
python scripts/train/ablation_study.py

# 运行特定实验
python scripts/train/ablation_study.py \
    --experiments backbone,attention

# 快速测试（减少训练轮数）
python scripts/train/ablation_study.py \
    --epochs 50 \
    --skip-existing
```

**实验列表**：
| 实验编号 | 实验名称 | 说明 |
|---------|---------|------|
| baseline | 基准模型 | YOLOv5s原生配置 |
| backbone_ghost | Ghost骨干 | 替换为Ghost-C3 |
| backbone_shuffle | Shuffle骨干 | 替换为Shuffle-C3 |
| loss_siou | SIoU损失 | 使用SIoU损失函数 |
| loss_eiou | EIoU损失 | 使用EIoU损失函数 |
| attention_cbam | CBAM注意力 | 添加CBAM模块 |
| attention_coordatt | CoordAtt | 添加坐标注意力 |
| combined | 组合最优 | 组合所有最优配置 |

---

## 评估脚本

### 1. eval_detection.py

**功能**：评估目标检测模型性能

**位置**：`scripts/evaluate/eval_detection.py`

**执行方式**：
```bash
python scripts/evaluate/eval_detection.py [选项]
```

**参数说明**：
| 参数 | 说明 | 默认值 | 必需 |
|-----|------|--------|------|
| --weights | 模型权重路径 | - | 是 |
| --data | 数据集配置 | configs/dataset.yaml | 否 |
| --batch-size | 批量大小 | 32 | 否 |
| --img-size | 图像尺寸 | 640 | 否 |
| --conf-thres | 置信度阈值 | 0.001 | 否 |
| --iou-thres | NMS IoU阈值 | 0.6 | 否 |
| --task | 评估任务 | val | 否 |
| --device | 计算设备 | 0 | 否 |
| --verbose | 详细输出 | False | 否 |
| --save-json | 保存COCO格式结果 | False | 否 |
| --output | 结果保存路径 | - | 否 |

**使用示例**：
```bash
# 基本评估
python scripts/evaluate/eval_detection.py \
    --weights outputs/weights/best.pt

# 详细评估并保存结果
python scripts/evaluate/eval_detection.py \
    --weights outputs/weights/best.pt \
    --verbose \
    --save-json \
    --output outputs/results/detection_eval.json

# 批量评估多个模型
python scripts/evaluate/eval_detection.py \
    --weights-dir outputs/weights/ \
    --output outputs/results/detection_comparison.csv
```

**输出指标**：
- mAP@0.5: IoU=0.5时的平均精度
- mAP@0.5:0.95: IoU从0.5到0.95的平均精度
- Precision: 精确率
- Recall: 召回率
- F1-Score: F1分数

---

### 2. eval_tracking.py

**功能**：评估多目标跟踪算法性能

**位置**：`scripts/evaluate/eval_tracking.py`

**执行方式**：
```bash
python scripts/evaluate/eval_tracking.py [选项]
```

**参数说明**：
| 参数 | 说明 | 默认值 | 必需 |
|-----|------|--------|------|
| --detector | 检测器权重路径 | - | 是 |
| --tracker | 跟踪算法 | deepsort | 否 |
| --video | 测试视频/序列路径 | - | 是 |
| --output | 结果输出目录 | outputs/results/ | 否 |
| --metrics | 评估指标 | mota,idf1,idsw | 否 |
| --visualize | 可视化跟踪结果 | False | 否 |
| --save-video | 保存跟踪视频 | False | 否 |
| --conf-thres | 检测置信度阈值 | 0.5 | 否 |
| --nms-thres | NMS阈值 | 0.4 | 否 |

**跟踪器选项**：
- `deepsort`: DeepSORT算法
- `bytetrack`: ByteTrack算法
- `centertrack`: CenterTrack算法

**使用示例**：
```bash
# 评估DeepSORT
python scripts/evaluate/eval_tracking.py \
    --detector outputs/weights/best.pt \
    --tracker deepsort \
    --video data/processed/kaist/test_sequences/

# 评估并可视化
python scripts/evaluate/eval_tracking.py \
    --detector outputs/weights/best.pt \
    --tracker bytetrack \
    --video data/processed/kaist/test_sequences/ \
    --visualize \
    --save-video
```

**输出指标**：
- MOTA: 多目标跟踪精度
- IDF1: 身份F1分数
- IDSW: 身份切换次数
- MOTP: 多目标跟踪精度（位置）
- FP: 误检数
- FN: 漏检数
- MT: 主要跟踪目标数
- ML: 主要丢失目标数

---

### 3. compare_trackers.py

**功能**：对比不同跟踪算法的性能

**位置**：`scripts/evaluate/compare_trackers.py`

**执行方式**：
```bash
python scripts/evaluate/compare_trackers.py [选项]
```

**参数说明**：
| 参数 | 说明 | 默认值 | 必需 |
|-----|------|--------|------|
| --detector | 检测器权重路径 | - | 是 |
| --video | 测试视频路径 | - | 是 |
| --trackers | 要对比的跟踪器列表 | deepsort,bytetrack,centertrack | 否 |
| --output | 对比结果输出 | outputs/results/tracking_comparison.csv | 否 |
| --scenarios | 测试场景 | all | 否 |

**使用示例**：
```bash
# 对比所有跟踪器
python scripts/evaluate/compare_trackers.py \
    --detector outputs/weights/best.pt \
    --video data/processed/kaist/test_sequences/

# 仅对比DeepSORT和ByteTrack
python scripts/evaluate/compare_trackers.py \
    --detector outputs/weights/best.pt \
    --video data/processed/kaist/test_sequences/ \
    --trackers deepsort,bytetrack
```

---

## 部署脚本

### 1. export_model.py

**功能**：将PyTorch模型导出为ONNX格式

**位置**：`scripts/deploy/export_model.py`

**执行方式**：
```bash
python scripts/deploy/export_model.py [选项]
```

**参数说明**：
| 参数 | 说明 | 默认值 | 必需 |
|-----|------|--------|------|
| --weights | PyTorch模型路径 | - | 是 |
| --output | ONNX输出路径 | - | 否 |
| --img-size | 输入图像尺寸 | 640 | 否 |
| --batch-size | 批量大小 | 1 | 否 |
| --dynamic | 动态batch | False | 否 |
| --simplify | 简化ONNX图 | True | 否 |
| --opset | ONNX opset版本 | 12 | 否 |

**使用示例**：
```bash
# 基本导出
python scripts/deploy/export_model.py \
    --weights outputs/weights/best.pt

# 完整参数
python scripts/deploy/export_model.py \
    --weights outputs/weights/best.pt \
    --output outputs/weights/best.onnx \
    --img-size 640 \
    --batch-size 1 \
    --simplify
```

---

### 2. convert_to_rknn.py

**功能**：将ONNX模型转换为RKNN格式

**位置**：`scripts/deploy/convert_to_rknn.py`

**执行方式**：
```bash
python scripts/deploy/convert_to_rknn.py [选项]
```

**参数说明**：
| 参数 | 说明 | 默认值 | 必需 |
|-----|------|--------|------|
| --onnx | ONNX模型路径 | - | 是 |
| --output | RKNN输出路径 | - | 否 |
| --platform | 目标平台 | rv1126 | 否 |
| --quantize | 量化类型 | int8 | 否 |
| --dataset | 量化校准数据集 | - | 否 |
| --pre-compile | 预编译模型 | False | 否 |

**使用示例**：
```bash
# 基本转换
python scripts/deploy/convert_to_rknn.py \
    --onnx outputs/weights/best.onnx

# INT8量化
python scripts/deploy/convert_to_rknn.py \
    --onnx outputs/weights/best.onnx \
    --quantize int8 \
    --dataset data/processed/flir/calibration/

# 预编译（针对特定硬件优化）
python scripts/deploy/convert_to_rknn.py \
    --onnx outputs/weights/best.onnx \
    --quantize int8 \
    --pre-compile \
    --platform rv1126
```

---

### 3. test_rknn.py

**功能**：测试RKNN模型推理性能

**位置**：`scripts/deploy/test_rknn.py`

**执行方式**：
```bash
python scripts/deploy/test_rknn.py [选项]
```

**参数说明**：
| 参数 | 说明 | 默认值 | 必需 |
|-----|------|--------|------|
| --model | RKNN模型路径 | - | 是 |
| --image | 测试图像路径 | - | 否 |
| --video | 测试视频路径 | - | 否 |
| --simulator | 使用PC模拟器 | False | 否 |
| --benchmark | 运行性能基准测试 | False | 否 |
| --iterations | 基准测试迭代次数 | 100 | 否 |

**使用示例**：
```bash
# PC模拟器测试
python scripts/deploy/test_rknn.py \
    --model outputs/weights/best.rknn \
    --image test_image.jpg \
    --simulator

# 性能基准测试
python scripts/deploy/test_rknn.py \
    --model outputs/weights/best.rknn \
    --benchmark \
    --iterations 1000
```

---

## 完整工作流程示例

以下是从数据准备到部署的完整执行流程：

```python
#!/usr/bin/env python3
"""
完整执行流程脚本
从数据准备到模型部署的一键执行
"""

import subprocess
import sys

def run_command(cmd, description):
    """执行命令并打印说明"""
    print(f"\n{'='*50}")
    print(f"步骤: {description}")
    print(f"命令: {cmd}")
    print('='*50)
    result = subprocess.run(cmd, shell=True)
    if result.returncode != 0:
        print(f"错误: {description} 失败!")
        sys.exit(1)

# 1. 下载数据集
run_command(
    "python scripts/data/download_dataset.py",
    "下载数据集"
)

# 2. 准备FLIR数据集
run_command(
    "python scripts/data/prepare_flir.py --input data/raw/flir",
    "准备FLIR数据集"
)

# 3. 准备KAIST数据集
run_command(
    "python scripts/data/prepare_kaist.py --input data/raw/kaist",
    "准备KAIST数据集"
)

# 4. 训练基准模型
run_command(
    "python scripts/train/train_yolov5.py --epochs 300 --name baseline",
    "训练基准模型"
)

# 5. 消融实验
run_command(
    "python scripts/train/ablation_study.py",
    "消融实验"
)

# 6. 评估检测性能
run_command(
    "python scripts/evaluate/eval_detection.py --weights outputs/weights/baseline/best.pt --verbose",
    "评估检测性能"
)

# 7. 对比跟踪算法
run_command(
    "python scripts/evaluate/compare_trackers.py --detector outputs/weights/baseline/best.pt --video data/processed/kaist/test_sequences/",
    "对比跟踪算法"
)

# 8. 导出ONNX模型
run_command(
    "python scripts/deploy/export_model.py --weights outputs/weights/baseline/best.pt",
    "导出ONNX模型"
)

# 9. 转换RKNN模型
run_command(
    "python scripts/deploy/convert_to_rknn.py --onnx outputs/weights/best.onnx --quantize int8 --dataset data/processed/flir/calibration/",
    "转换RKNN模型"
)

# 10. 测试RKNN模型
run_command(
    "python scripts/deploy/test_rknn.py --model outputs/weights/best.rknn --simulator --benchmark",
    "测试RKNN模型"
)

print("\n" + "="*50)
print("全部流程执行完成!")
print("="*50)
```

---

## 故障排除

### 常见问题

1. **CUDA内存不足**
   ```bash
   # 减小批量大小
   --batch-size 16
   ```

2. **数据集路径错误**
   ```bash
   # 使用绝对路径
   --input /full/path/to/dataset
   ```

3. **RKNN转换失败**
   ```bash
   # 检查ONNX模型兼容性
   python -c "import onnx; onnx.checker.check_model('model.onnx')"
   ```

4. **跟踪器初始化失败**
   ```bash
   # 安装缺失依赖
   pip install filterpy lap
   ```
