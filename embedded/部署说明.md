# RV1126嵌入式部署说明

本文档说明如何将训练好的红外目标检测与跟踪模型部署到RV1126开发板上。

## 目录

1. [硬件准备](#硬件准备)
2. [软件环境](#软件环境)
3. [模型转换](#模型转换)
4. [程序编译](#程序编译)
5. [部署运行](#部署运行)
6. [性能优化](#性能优化)

---

## 硬件准备

### 开发板
- Rockchip RV1126开发板
- 内存: 1GB DDR4
- NPU: 2.0 TOPS

### 外设
- 红外摄像头模组
- SD卡 (32GB以上，推荐Class 10)
- USB Type-C数据线
- 电源适配器 (5V/3A)

### 连接方式
```
PC (开发机) <--USB/网络--> RV1126开发板 <--MIPI/USB--> 红外摄像头
```

---

## 软件环境

### PC端环境

```bash
# 1. 安装交叉编译工具链（RV1126使用32位ARM）
sudo apt-get install gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf

# 2. 安装RKNN Toolkit2
pip install rknn-toolkit2

# 3. 验证安装
arm-linux-gnueabihf-gcc --version
python -c "from rknn.api import RKNN; print('RKNN Toolkit OK')"
```

### 开发板环境

```bash
# 开发板已预装以下组件:
# - librknnrt.so (NPU运行时库)
# - OpenCV (图像处理)
# - RGA (图像加速)

# 检查NPU驱动
cat /proc/rkisp-vir0
```

---

## 模型转换

### 步骤1: 导出ONNX

```bash
# 在PC端执行
python scripts/deploy/export_model.py \
    --weights outputs/weights/best.pt \
    --img-size 640 \
    --simplify
```

### 步骤2: 转换RKNN

```bash
# 在PC端执行
python scripts/deploy/convert_to_rknn.py \
    --onnx outputs/weights/best.onnx \
    --platform rv1126 \
    --quantize int8 \
    --dataset data/processed/flir/calibration/
```

### 步骤3: 验证模型

```bash
# PC模拟器测试
python scripts/deploy/test_rknn.py \
    --model outputs/weights/best.rknn \
    --image test.jpg \
    --simulator
```

---

## 程序编译

### 目录结构

```
embedded/
├── include/
│   ├── detector.h          # 检测器头文件
│   ├── tracker.h           # 跟踪器头文件
│   └── pipeline.h          # 处理流水线头文件
├── src/
│   ├── main.cpp            # 主程序入口
│   ├── detector.cpp        # 检测器实现
│   ├── tracker.cpp         # 跟踪器实现
│   └── pipeline.cpp        # 处理流水线实现
├── lib/                    # 第三方库
├── configs/                # 配置文件
├── CMakeLists.txt          # CMake配置
└── toolchain.cmake         # 交叉编译工具链配置
```

### 编译步骤

```bash
cd embedded

# 1. 创建构建目录
mkdir -p build && cd build

# 2. 配置CMake (交叉编译)
cmake .. -DCMAKE_TOOLCHAIN_FILE=../toolchain.cmake

# 3. 编译
make -j4

# 编译产物:
# - build/infrared_tracker (主程序)
# - build/performance_test (性能测试工具)
```

---

## 部署运行

### 传输文件

```bash
# 创建目标目录
ssh root@rv1126 "mkdir -p /opt/infrared_tracker/{models,configs,lib}"

# 传输程序
scp build/infrared_tracker root@rv1126:/opt/infrared_tracker/

# 传输模型
scp ../../outputs/weights/best.rknn root@rv1126:/opt/infrared_tracker/models/

# 传输配置
scp ../configs/* root@rv1126:/opt/infrared_tracker/configs/
```

### 运行程序

```bash
# 登录开发板
ssh root@rv1126

# 进入程序目录
cd /opt/infrared_tracker

# 运行检测跟踪
./infrared_tracker \
    --model models/best.rknn \
    --config configs/deploy.yaml \
    --source /dev/video0

# 运行性能测试
./performance_test \
    --model models/best.rknn \
    --duration 60
```

### 开机自启动

```bash
# 创建systemd服务文件
cat > /etc/systemd/system/infrared-tracker.service << EOF
[Unit]
Description=Infrared Object Tracker
After=network.target

[Service]
Type=simple
ExecStart=/opt/infrared_tracker/infrared_tracker --config /opt/infrared_tracker/configs/deploy.yaml
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# 启用服务
systemctl enable infrared-tracker
systemctl start infrared-tracker

# 查看状态
systemctl status infrared-tracker
```

---

## 性能优化

### NPU优化

1. **批处理**: 使用batch size=1保证实时性
2. **预编译**: 使用`--pre-compile`选项减少首次加载时间
3. **核心分配**: 使用双核NPU并行推理

### 内存优化

1. **零拷贝**: 使用DMA直接访问摄像头数据
2. **内存池**: 预分配缓冲区避免动态分配
3. **数据对齐**: 确保数据按NPU要求对齐

### 流水线优化

```
帧获取 → 预处理 → NPU推理 → 后处理 → 跟踪更新 → 结果输出
  ↓         ↓         ↓          ↓          ↓          ↓
 异步      RGA加速   NPU加速    CPU并行    CPU       异步
```

### 性能目标

| 模块 | 目标时间 | 备注 |
|-----|---------|------|
| 图像获取 | <5ms | V4L2 + DMA |
| 预处理 | <5ms | RGA硬件加速 |
| NPU推理 | <25ms | INT8量化 |
| 后处理 | <3ms | NMS + 解码 |
| 跟踪更新 | <2ms | 卡尔曼滤波 |
| **总计** | **<40ms** | **≥25FPS** |

---

## 常见问题

### 问：NPU推理失败？
答：检查模型格式是否正确，确保使用rv1126平台转换

### 问：帧率达不到要求？
答：
1. 检查是否开启了NPU加速
2. 降低输入分辨率
3. 优化后处理代码

### 问：摄像头无法打开？
答：
1. 检查设备节点：`ls /dev/video*`
2. 检查权限：`chmod 666 /dev/video0`
3. 检查驱动：`dmesg | grep camera`

### 问：内存不足？
答：
1. 减小输入缓冲区数量
2. 使用更小的模型
3. 关闭不必要的后台服务
