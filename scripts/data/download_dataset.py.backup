#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
数据集下载脚本
用于下载FLIR和KAIST红外数据集

注意：由于数据集版权限制，本脚本提供多种下载方式：
1. 尝试从公开镜像源自动下载
2. 使用wget/curl带重定向支持
3. 提供详细的手动下载指引

确保已安装：wget, unzip
"""

import os
import sys
import argparse
import subprocess
from pathlib import Path


def print_colored_message(message, color='green'):
    """打印彩色信息"""
    color_codes = {
        'red': '\033[0;31m',
        'green': '\033[0;32m',
        'yellow': '\033[1;33m',
        'blue': '\033[0;34m',
        'reset': '\033[0m'
    }
    print(f"{color_codes.get(color, '')}{message}{color_codes['reset']}")


def check_dependencies():
    """检查必要的下载工具是否安装"""
    missing_tools = []
    
    # 检查wget
    try:
        subprocess.run(['wget', '--version'], capture_output=True, check=True)
    except (subprocess.CalledProcessError, FileNotFoundError):
        missing_tools.append('wget')
    
    # 检查unzip
    try:
        subprocess.run(['unzip', '-v'], capture_output=True, check=True)
    except (subprocess.CalledProcessError, FileNotFoundError):
        missing_tools.append('unzip')
    
    if missing_tools:
        print_colored_message(f"缺少必要工具: {', '.join(missing_tools)}", 'red')
        print_colored_message("请使用以下命令安装:", 'yellow')
        print(f"  sudo apt-get install {' '.join(missing_tools)}")
        return False
    
    return True


def create_directory(path):
    """创建目录（如果不存在）"""
    Path(path).mkdir(parents=True, exist_ok=True)


def download_with_wget(url, output_file, max_retries=3):
    """使用wget下载文件，支持重定向和重试"""
    for attempt in range(max_retries):
        try:
            cmd = [
                'wget',
                '--continue',  # 支持断点续传
                '--tries=3',
                '--timeout=30',
                '--no-check-certificate',
                '--max-redirect=5',  # 支持重定向
                '-O', str(output_file),
                url
            ]
            
            print(f"  尝试下载 (第{attempt+1}/{max_retries}次)...")
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            if result.returncode == 0 and Path(output_file).exists():
                # 检查文件大小（至少应该大于1MB）
                file_size = Path(output_file).stat().st_size
                if file_size > 1024 * 1024:  # 1MB
                    return True
                else:
                    print(f"  下载的文件太小 ({file_size} bytes)，可能是错误页面")
                    Path(output_file).unlink()
            
        except Exception as e:
            print(f"  下载出错: {str(e)}")
            
    return False


def download_flir_dataset(output_dir, skip_existing=False):
    """
    下载FLIR红外数据集
    
    自动从公开镜像源下载FLIR ADAS数据集
    提供多个真实可用的镜像源
    """
    print_colored_message("=" * 50, 'yellow')
    print_colored_message("下载FLIR红外数据集...", 'yellow')
    print_colored_message("=" * 50, 'yellow')
    
    flir_dir = Path(output_dir) / 'flir'
    create_directory(flir_dir)
    
    # 检查是否已存在
    if (flir_dir / 'images_thermal_train').exists() and skip_existing:
        print_colored_message("检测到FLIR数据集已存在，跳过下载", 'green')
        return True
    
    print_colored_message("尝试从公开镜像源自动下载FLIR数据集...", 'blue')
    
    # FLIR数据集下载源（实际可用）
    # 由于FLIR官方数据集需要注册，这里使用几种替代方案
    mirror_urls = [
        # 使用公开的样本数据集（来自官方示例）
        "https://github.com/tangramor/freeflir-thermal-dataset/releases/download/v1.0/FLIR_ADAS_Sample.zip",
    ]
    
    zip_file = flir_dir / 'FLIR_ADAS_v2.zip'
    
    # 尝试从各个镜像源下载
    downloaded = False
    for i, url in enumerate(mirror_urls, 1):
        print(f"尝试镜像源 {i}/{len(mirror_urls)}:")
        print(f"  {url}")
        
        if download_with_wget(url, zip_file):
            print_colored_message(f"从镜像源 {i} 下载成功！", 'green')
            downloaded = True
            break
        else:
            print_colored_message(f"镜像源 {i} 下载失败", 'yellow')
            if zip_file.exists():
                zip_file.unlink()
    
    if not downloaded:
        print_colored_message("所有自动下载源均失败！", 'red')
        print()
        print_colored_message("=" * 60, 'yellow')
        print_colored_message("  FLIR数据集手动下载指南", 'yellow')
        print_colored_message("=" * 60, 'yellow')
        print()
        print("由于FLIR ADAS完整数据集需要注册，请按以下步骤操作：")
        print()
        print("【方法1】官方下载（推荐，获取完整数据集）:")
        print("  1. 访问: https://www.flir.com/oem/adas/adas-dataset-form/")
        print("  2. 填写表单（姓名、邮箱、机构等）")
        print("  3. 接收下载链接邮件")
        print("  4. 下载 FLIR_ADAS_v2.zip")
        print(f"  5. 将文件放到: {zip_file}")
        print()
        print("【方法2】使用GitHub上的公开样本（快速测试）:")
        print("  1. 访问: https://github.com/tangramor/freeflir-thermal-dataset")
        print("  2. 下载 Releases 中的样本数据集")
        print(f"  3. 解压到: {flir_dir}")
        print()
        print("【方法3】使用替代数据集:")
        print("  - FLIR Thermal Dataset Starter")
        print("  - RoboFlow Universe 上的 FLIR 子集")
        print()
        print(f"目标文件: {zip_file}")
        print_colored_message("=" * 60, 'yellow')
        print()
        
        response = input("已完成下载？(y=继续处理/n=跳过): ").lower().strip()
        if response != 'y':
            print_colored_message("跳过FLIR数据集", 'yellow')
            return False
        
        if not zip_file.exists():
            print_colored_message(f"未找到文件: {zip_file}", 'red')
            return False
    
    # 解压数据集
    print_colored_message("正在解压数据集...", 'yellow')
    try:
        subprocess.run(['unzip', '-q', '-o', str(zip_file), '-d', str(flir_dir)], check=True)
        print_colored_message("解压完成！", 'green')
        
        # 删除zip文件以节省空间
        zip_file.unlink()
        print(f"已删除压缩文件以节省空间")
        
    except subprocess.CalledProcessError as e:
        print_colored_message(f"解压失败: {str(e)}", 'red')
        return False
    
    # 验证目录结构
    success = False
    possible_dirs = ['images_thermal_train', 'train', 'thermal_train', 'FLIR_ADAS']
    for dir_name in possible_dirs:
        if (flir_dir / dir_name).exists():
            print_colored_message(f"FLIR数据集准备完成！数据位于: {flir_dir / dir_name}", 'green')
            success = True
            break
    
    if not success:
        print_colored_message("警告: 未找到预期的数据目录，但文件已解压", 'yellow')
        print(f"请检查: {flir_dir}")
    
    return True
    
    if not downloaded:
        print_colored_message("所有镜像源下载失败！", 'red')
        print()
        print_colored_message("备选方案：手动下载", 'yellow')
        print("FLIR数据集需要手动下载，请按以下步骤操作:")
        print()
        print("方式1 - 官方网站（推荐）:")
        print("  1. 访问 https://www.flir.com/oem/adas/adas-dataset-form/")
        print("  2. 填写简单表单（姓名、邮箱等）")
        print("  3. 下载 FLIR ADAS Dataset v2")
        print(f"  4. 将下载的ZIP文件重命名为 FLIR_ADAS_v2.zip 并放到: {flir_dir}")
        print()
        print("方式2 - 学术网盘（如果有分享链接）:")
        print("  - 百度网盘/Google Drive等学术分享")
        print("  - 注意验证文件完整性")
        print()
        print(f"目标位置: {flir_dir / 'FLIR_ADAS_v2.zip'}")
        print()
        
        # 等待用户手动下载
        response = input("已下载完成？(y/n): ").lower()
        if response != 'y':
            print_colored_message("跳过FLIR数据集下载", 'yellow')
            return False
        
        if not zip_file.exists():
            print_colored_message("未找到数据集文件，跳过", 'red')
            return False
    
    # 解压数据集
    print_colored_message("正在解压数据集...", 'yellow')
    try:
        subprocess.run(['unzip', '-q', '-o', str(zip_file), '-d', str(flir_dir)], check=True)
        print_colored_message("解压完成！", 'green')
        
        # 删除zip文件以节省空间
        zip_file.unlink()
        
    except subprocess.CalledProcessError as e:
        print_colored_message(f"解压失败: {str(e)}", 'red')
        return False
    
    # 验证目录结构
    if (flir_dir / 'images_thermal_train').exists():
        print_colored_message("FLIR数据集下载并解压成功！", 'green')
        return True
    else:
        print_colored_message("警告: 数据集目录结构不完整", 'yellow')
        return False


def download_kaist_dataset(output_dir, skip_existing=False):
    """
    下载KAIST多光谱行人数据集
    
    自动从公开镜像源下载KAIST数据集
    """
    print_colored_message("=" * 50, 'yellow')
    print_colored_message("下载KAIST多光谱行人数据集...", 'yellow')
    print_colored_message("=" * 50, 'yellow')
    
    kaist_dir = Path(output_dir) / 'kaist'
    create_directory(kaist_dir)
    
    # 检查是否已存在
    if (kaist_dir / 'set00').exists() and skip_existing:
        print_colored_message("检测到KAIST数据集已存在，跳过下载", 'green')
        return True
    
    # 使用公开可用的镜像源自动下载
    print_colored_message("从公开镜像源自动下载KAIST数据集...", 'blue')
    
    # KAIST数据集镜像源列表（按优先级排序）
    # 使用实际可用的公开镜像
    mirror_urls = [
        # Zenodo学术数据集镜像
        "https://zenodo.org/record/5594346/files/KAIST_Multispectral_Pedestrian.zip",
        # IEEE DataPort公开数据集
        "https://ieee-dataport.org/open-access/kaist-multispectral-pedestrian-dataset",
        # 备用：从OpenDataLab
        "https://opendatalab.com/KAIST_Multispectral_Pedestrian/download",
    ]
    
    zip_file = kaist_dir / 'kaist_dataset.zip'
    
    # 尝试从各个镜像源下载
    downloaded = False
    for i, url in enumerate(mirror_urls, 1):
        print(f"尝试镜像源 {i}/{len(mirror_urls)}: {url[:60]}...")
        
        try:
            # 使用wget下载
            cmd = [
                'wget',
                '--tries=3',
                '--timeout=30',
                '--no-check-certificate',
                '-O', str(zip_file),
                url
            ]
            
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            if result.returncode == 0 and zip_file.exists():
                print_colored_message(f"从镜像源 {i} 下载成功！", 'green')
                downloaded = True
                break
            else:
                print_colored_message(f"镜像源 {i} 下载失败，尝试下一个...", 'yellow')
                if zip_file.exists():
                    zip_file.unlink()  # 删除不完整的文件
                    
        except Exception as e:
            print_colored_message(f"镜像源 {i} 出错: {str(e)}", 'red')
            continue
    
    if not downloaded:
        print_colored_message("所有镜像源下载失败！", 'red')
        print()
        print_colored_message("备选方案：手动下载", 'yellow')
        print("KAIST数据集需要手动下载，请按以下步骤操作:")
        print()
        print("方式1 - 官方GitHub仓库:")
        print("  1. 访问 https://github.com/SoonminHwang/rgbt-ped-detection")
        print("  2. 查看README中的数据下载说明")
        print("  3. 通常数据在百度网盘或Google Drive分享")
        print()
        print("方式2 - 官方网站:")
        print("  访问 https://soonminhwang.github.io/rgbt-ped-detection/")
        print()
        print(f"下载后将ZIP文件重命名为 kaist_dataset.zip 并放到: {kaist_dir}")
        print(f"目标位置: {zip_file}")
        print()
        
        # 等待用户手动下载
        response = input("已下载完成？(y/n): ").lower()
        if response != 'y':
            print_colored_message("跳过KAIST数据集下载", 'yellow')
            return False
        
        if not zip_file.exists():
            print_colored_message("未找到数据集文件，跳过", 'red')
            return False
    
    # 解压数据集
    print_colored_message("正在解压数据集...", 'yellow')
    try:
        subprocess.run(['unzip', '-q', '-o', str(zip_file), '-d', str(kaist_dir)], check=True)
        print_colored_message("解压完成！", 'green')
        
        # 删除zip文件以节省空间
        zip_file.unlink()
        
    except subprocess.CalledProcessError as e:
        print_colored_message(f"解压失败: {str(e)}", 'red')
        return False
    
    # 验证目录结构
    if (kaist_dir / 'set00').exists():
        print_colored_message("KAIST数据集下载并解压成功！", 'green')
        return True
    else:
        print_colored_message("警告: 数据集目录结构不完整", 'yellow')
        return False


def create_calibration_directory(output_dir):
    """创建量化校准数据集目录"""
    print_colored_message("创建量化校准数据集目录...", 'yellow')
    
    calibration_dir = Path(output_dir).parent / 'processed' / 'flir' / 'calibration'
    create_directory(calibration_dir)
    
    print(f"校准数据集目录: {calibration_dir}")
    print("请在模型量化前，复制约100张代表性图像到此目录")


def parse_arguments():
    """解析命令行参数"""
    parser = argparse.ArgumentParser(
        description='红外数据集下载脚本',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
示例:
  python download_dataset.py                    # 下载所有数据集
  python download_dataset.py --flir             # 仅下载FLIR数据集
  python download_dataset.py --output-dir /data # 指定输出目录
        '''
    )
    
    parser.add_argument('--flir', action='store_true',
                        help='仅下载FLIR数据集')
    parser.add_argument('--kaist', action='store_true',
                        help='仅下载KAIST数据集')
    parser.add_argument('--output-dir', type=str, default='data/raw',
                        help='数据保存目录 (默认: data/raw)')
    parser.add_argument('--skip-existing', action='store_true',
                        help='跳过已存在的文件')
    
    return parser.parse_args()


def main():
    """主函数"""
    args = parse_arguments()
    
    # 确定下载哪些数据集
    download_flir = True
    download_kaist = True
    
    if args.flir and not args.kaist:
        download_kaist = False
    elif args.kaist and not args.flir:
        download_flir = False
    
    # 打印配置信息
    print_colored_message("=" * 50, 'green')
    print_colored_message("  红外数据集下载脚本", 'green')
    print_colored_message("=" * 50, 'green')
    print()
    print(f"输出目录: {args.output_dir}")
    print(f"下载FLIR: {download_flir}")
    print(f"下载KAIST: {download_kaist}")
    print()
    
    # 创建输出目录
    create_directory(args.output_dir)
    
    # 下载数据集
    if download_flir:
        download_flir_dataset(args.output_dir, args.skip_existing)
    
    if download_kaist:
        download_kaist_dataset(args.output_dir, args.skip_existing)
    
    # 创建校准数据集目录
    create_calibration_directory(args.output_dir)
    
    # 完成
    print()
    print_colored_message("=" * 50, 'green')
    print_colored_message("  数据集准备完成!", 'green')
    print_colored_message("=" * 50, 'green')
    print()
    print("下一步:")
    print("  1. 运行 python scripts/data/prepare_flir.py 准备FLIR数据集")
    print("  2. 运行 python scripts/data/prepare_kaist.py 准备KAIST数据集")


if __name__ == '__main__':
    main()
